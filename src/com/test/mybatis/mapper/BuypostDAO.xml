<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.IBuypostDAO">

	<!-- 대분류 카테고리 -->
	<select id="mainCateList" resultType="com.test.mybatis.MainCategoryDTO">
		SELECT CODE, NAME
		FROM MAIN_CATE	
	</select>
	
	<!--==================================== 공동구매 목록 ===================================-->
	
	<!-- 메인(32개) -->
	<select id="buypostList_main" resultType="com.test.mybatis.BuypostDTO">
		SELECT ROWNUM, CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		     , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND ROWNUM <![CDATA[<=]]> 32	
	</select>
	
	<!-- 서브카테고리로 메인카테고리 찾기 -->
	<select id="searchMainCate" resultType="java.lang.String">
		SELECT MAIN_CATE_CODE
		FROM SUB_CATE
		WHERE CODE = #{sub_cate_code}	
	</select>
	
	<!-- 메인카테고리 & 서브카테고리 이름 -->
	<select id="categoryList" resultType="com.test.mybatis.SubCategoryDTO">
		SELECT M.CODE "MAIN_CATE_CODE", M.NAME "MAIN_CATE_NAME", S.CODE, S.NAME
		FROM MAIN_CATE M JOIN SUB_CATE S
		    ON M.CODE = S.MAIN_CATE_CODE
		WHERE MAIN_CATE_CODE = #{main_cate_code}    
		ORDER BY M.CODE, S.CODE	
	</select>
	
	<!-- 카테고리 목록 개수 -->
	<select id="count_category" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE = #{main_cate_code}
		  AND SUB_CATE_CODE LIKE '%'||#{sub_cate_code}||'%'	
	</select>
	
	<!-- 카테고리 -->
	<select id="buypostList_category" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM 
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||#{user_region}||'%'
				  AND MAIN_CATE_CODE = #{main_cate_code}
				  AND SUB_CATE_CODE LIKE '%'||#{sub_cate_code}||'%'	
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}		  	  
	</select>
	
	<!-- 최근공구 목록 개수 -->
	<select id="count_new" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		  AND WRITE_DATETIME <![CDATA[<]]> SYSDATE - 7	
	</select>
	
	<!-- 최근공구 -->
	<select id="buypostList_new" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||#{user_region}||'%'
		          AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		          AND WRITE_DATETIME <![CDATA[<]]> SYSDATE - 7
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}
	</select>
	
	<!-- 마감임박 목록 개수 -->
	<select id="count_final" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		  AND DEADLINE - SYSDATE <![CDATA[<]]> 1	
	</select>
	
	<!-- 마감임박 -->
	<select id="buypostList_final" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||#{user_region}||'%'
		          AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		          AND DEADLINE - SYSDATE <![CDATA[<]]> 1
		        ORDER BY DEADLINE, WRITE_DATETIME DESC
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}
	</select>
	
	<!-- 검색 목록 개수 -->
	<select id="count_search" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		  AND (TITLE LIKE '%'||#{searchType}||'%' 
		       OR CONTENT LIKE '%'||#{searchType}||'%'
		       OR REGION LIKE '%'||#{searchType}||'%'
		       OR SUB_CATE_CODE = (SELECT CODE
		                           FROM SUB_CATE
		                           WHERE NAME LIKE '%'||#{searchType}||'%'))	
	</select>
	
	<!-- 검색 -->
	<select id="buypostList_search" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM 
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
				WHERE REGION LIKE '%'||#{user_region}||'%'
				  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
				  AND (TITLE LIKE '%'||#{searchType}||'%' 
				       OR CONTENT LIKE '%'||#{searchType}||'%'
				       OR REGION LIKE '%'||#{searchType}||'%'
				       OR SUB_CATE_CODE = (SELECT CODE
				                           FROM SUB_CATE
				                           WHERE NAME LIKE '%'||#{searchType}||'%'))
				ORDER BY DEADLINE, WRITE_DATETIME DESC	
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}
	</select>
	
	<!--==================================== 공동구매 목록 ===================================-->
	
	<!--============================== 공동구매 게시물 상세보기 ==============================-->
	
	<!-- 상세보기 -->
	<select id="buypostArticle" resultType="com.test.mybatis.BuypostDTO">
		SELECT MEMBER_CODE 
		     , (SELECT NICKNAME FROM MEMBER_INFO WHERE MEMBER_CODE = BP.MEMBER_CODE) "NICKNAME"
		     , (SELECT PHOTO_NAME FROM VIEW_PROFILE WHERE MEMBER_CODE = BP.MEMBER_CODE) "PHOTO_NAME"
		     , CODE, TITLE, URL, EXPIRATION_DATETIME, GOODS_PHOTO_NAME
		     , TO_CHAR(CEIL(TOTAL_PRICE/GOODS_NUM), 'FM999,999,999,999') "PRICE"
		     , (SELECT SUM(NVL(BUY_NUMBER, 0)) FROM BUYPOST_PARTICIPANT WHERE BUYPOST_CODE = BP.CODE) "BUY_NUMBER"
		     , GOODS_NUM
		     , TRADE_DATETIME
		     , TRUNC((DEADLINE - SYSDATE) * (24*60*60)/60/60/24) "LEFT_DAY"
		     , TRUNC(MOD((DEADLINE - SYSDATE) * (24*60*60)/60/60, 24)) "LEFT_HOUR"
		     , TRUNC(MOD((DEADLINE - SYSDATE) * (24*60*60)/60, 60)) "LEFT_MINUTE"
		     , LOCATION_X, LOCATION_Y
		     , CONTENT
		     , (SELECT NVL(MAX(NAME), NULL) FROM BUYPOST_PHOTO WHERE BUYPOST_CODE = BP.CODE) "CONTENT_PHOTO_NAME"
		     , (SELECT MAIN_CATE_CODE FROM SUB_CATE WHERE CODE = BP.SUB_CATE_CODE) "MAIN_CATE_CODE", SUB_CATE_CODE
		     , (SELECT M.NAME FROM MAIN_CATE M JOIN SUB_CATE S ON M.CODE = S.MAIN_CATE_CODE WHERE S.CODE = BP.SUB_CATE_CODE) "MAIN_CATE_NAME"
		     , (SELECT NAME FROM SUB_CATE WHERE CODE = BP.SUB_CATE_CODE) "SUB_CATE_NAME"
		FROM BUYPOST BP
		WHERE CODE = #{code}
	</select>
	
	<!-- 참여자 목록 -->
	<select id="participant_info" resultType="com.test.mybatis.MemberDTO">
		SELECT P.NICKNAME, P.PHOTO_NAME
		FROM BUYPOST_PARTICIPANT B JOIN VIEW_PROFILE P
		    ON B.MEMBER_CODE = P.MEMBER_CODE
		WHERE BUYPOST_CODE = #{code}	
		ORDER BY TO_NUMBER(SUBSTR(B.CODE, 5)) ASC
	</select>
		
	<!--============================== 공동구매 게시물 상세보기 ==============================-->	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	

</mapper>