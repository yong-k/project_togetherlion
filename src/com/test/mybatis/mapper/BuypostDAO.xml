<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.test.mybatis.IBuypostDAO">

	<!-- 대분류 카테고리 -->
	<select id="mainCateList" resultType="com.test.mybatis.MainCategoryDTO">
		SELECT CODE, NAME
		FROM MAIN_CATE	
	</select>
	
	<!--==================== 공동구매 목록 ====================-->
	<!-- 메인(32개) -->
	<select id="buypostList_main" resultType="com.test.mybatis.BuypostDTO">
		SELECT ROWNUM, CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		     , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND ROWNUM <![CDATA[<=]]> 32	
	</select>
	
	<!-- 서브카테고리로 메인카테고리 찾기 -->
	<select id="searchMainCate" resultType="java.lang.String">
		SELECT MAIN_CATE_CODE
		FROM SUB_CATE
		WHERE CODE = #{sub_cate_code}	
	</select>
	
	<!-- 메인카테고리 & 서브카테고리 이름 -->
	<select id="categoryList" resultType="com.test.mybatis.SubCategoryDTO">
		SELECT M.CODE "MAIN_CATE_CODE", M.NAME "MAIN_CATE_NAME", S.CODE, S.NAME
		FROM MAIN_CATE M JOIN SUB_CATE S
		    ON M.CODE = S.MAIN_CATE_CODE
		WHERE MAIN_CATE_CODE = #{main_cate_code}    
		ORDER BY M.CODE, S.CODE	
	</select>
	
	<!-- 카테고리 목록 개수 -->
	<select id="count_category" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE = #{main_cate_code}
		  AND SUB_CATE_CODE LIKE '%'||#{sub_cate_code}||'%'	
	</select>
	
	<!-- 카테고리 -->
	<select id="buypostList_category" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM 
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||#{user_region}||'%'
				  AND MAIN_CATE_CODE = #{main_cate_code}
				  AND SUB_CATE_CODE LIKE '%'||#{sub_cate_code}||'%'	
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}		  	  
	</select>
	
	<!-- 최근공구 목록 개수 -->
	<select id="count_new" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		  AND WRITE_DATETIME <![CDATA[<]]> SYSDATE - 7	
	</select>
	
	<!-- 최근공구 -->
	<select id="buypostList_new" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||#{user_region}||'%'
		          AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		          AND WRITE_DATETIME <![CDATA[<]]> SYSDATE - 7
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}
	</select>
	
	<!-- 마감임박 목록 개수 -->
	<select id="count_final" resultType="java.lang.Integer">
		SELECT COUNT(*) COUNT
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		  AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		  AND DEADLINE - SYSDATE <![CDATA[<=]]> -1	
	</select>
	
	<!-- 마감임박 -->
	<select id="buypostList_final" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, COUNT, GOODS_PHOTO_NAME, LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM
		(
		    SELECT ROWNUM RNUM, T.*
		    FROM
		    (
		        SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		             , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		        FROM VIEW_BUYPOSTLIST
		        WHERE REGION LIKE '%'||''||'%'
		          AND MAIN_CATE_CODE LIKE '%'||#{main_cate_code}||'%'
		          AND DEADLINE - SYSDATE <![CDATA[<=]]> -1
		    ) T
		    WHERE ROWNUM <![CDATA[<]]> #{startList} + #{listSize}
		)
		WHERE RNUM <![CDATA[>=]]> #{startList}
	</select>
	
	<!-- 검색 목록 개수 -->
	<select id="count_search" resultType="java.lang.Integer">
	
	</select>
	
	<!-- 검색 -->
	<select id="buypostList_search" resultType="com.test.mybatis.BuypostDTO">
		SELECT CODE, TITLE, AMOUNT, BUY_NUMBER||'/'||GOODS_NUM "COUNT", GOODS_PHOTO_NAME
		     , LEFT_DAY, LEFT_HOUR, LEFT_MINUTE
		FROM VIEW_BUYPOSTLIST
		WHERE REGION LIKE '%'||#{user_region}||'%'
		AND TITLE LIKE '%'||#{searchType}||'%'
		    OR CONTENT LIKE '%'||#{searchType}||'%'
		    OR REGION LIKE '%'||#{searchType}||'%'
		    OR SUB_CATE_CODE = (SELECT CODE
		                        FROM SUB_CATE
		                        WHERE NAME LIKE '%'||#{searchType}||'%')	
	</select>
	
	<!--==================== 공동구매 목록 ====================-->

</mapper>